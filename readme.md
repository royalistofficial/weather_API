# Тестовое задание для стажера на позицию «Программист на языке Python»

## Установка

Для работы с проектом вам потребуется Python версии 3.12.8 или выше. Убедитесь, что у вас установлен Python, выполнив следующую команду:

```bash
python --version
```

### Шаги по установке

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/royalistofficial/weather_API.git
   ```

2. Перейдите в директорию проекта:

   ```bash
   cd weather_API
   ```

3. Создайте виртуальное окружение (рекомендуется):

   ```bash
   python -m venv venv
   ```

4. Активируйте виртуальное окружение:

   - На Windows:

     ```bash
     venv\Scripts\activate
     ```

   - На macOS и Linux:

     ```bash
     source venv/bin/activate
     ```

5. Установите зависимости из файла `requirements.txt`:

   ```bash
   pip install -r requirements.txt
   ```

## Запуск

Для запуска скрипта используйте следующую команду:

```bash
python script.py
```

## Тестирование

```bash
python tests.py
```

## Описание функций

### `async def index(request)`

Обрабатывает HTTP-запрос для главной страницы и возвращает данные о погоде для городов заданых пользователяем.

**Параметры:**
- `request` (HttpRequest): Объект запроса, содержащий информацию о текущем пользователе и его запросе.

**Возвращает:**
- `HttpResponse`: HTML-ответ, отрендеренный с данными о пользователе и погоде в его городах.

---

### `async def about(request)`

Обрабатывает HTTP-запрос для страницы "О нас" и возвращает соответствующий HTML-шаблон.

**Параметры:**
- `request` (HttpRequest): Объект запроса, содержащий информацию о текущем запросе.

**Возвращает:**
- `HttpResponse`: HTML-ответ, отрендеренный с шаблоном `about.html`.

---

### `async def fetch_weacther_data(user_city)`

Получает данные о погоде для указанного города пользователя.

**Параметры:**
- `user_city` (UserCity): Объект, содержащий информацию о городе, для которого необходимо получить данные о погоде.

**Возвращает:**
- `tuple`: Кортеж, содержащий имя города и словарь с данными о погоде и объектом города, если данные успешно получены; в противном случае — имя города и `None`.

---

### `async def registration(request)`

Обрабатывает HTTP-запрос для регистрации нового пользователя.

**Параметры:**
- `request` (HttpRequest): Объект запроса, содержащий данные о регистрации пользователя.

**Возвращает:**
- `HttpResponse`: HTML-ответ, отрендеренный с шаблоном `registration.html`, или перенаправление на главную страницу после успешной регистрации.

---

### `async def myLogin(request)`

Обрабатывает HTTP-запрос для входа пользователя в систему.

**Параметры:**
- `request` (HttpRequest): Объект запроса, содержащий данные для входа пользователя.

**Возвращает:**
- `HttpResponse`: HTML-ответ, отрендеренный с шаблоном `login.html`, или перенаправление на главную страницу после успешного входа.

---

### `async def myLogout(request)`

Обрабатывает HTTP-запрос для выхода пользователя из системы.

**Параметры:**
- `request` (HttpRequest): Объект запроса, содержащий информацию о текущем пользователе.

**Возвращает:**
- `HttpResponse`: Перенаправление на главную страницу после выхода пользователя.

---

### `async def weather_view(request)`

Обрабатывает HTTP-запрос для отображения данных о погоде на основе координат.

**Параметры:**
- `request` (HttpRequest): Объект запроса, содержащий информацию о текущем пользователе и параметры для получения данных о погоде.

**Возвращает:**
- `HttpResponse`: HTML-ответ, отрендеренный с шаблоном `weather.html`, содержащий данные о погоде или сообщение об ошибке.

---

### `async def add_city(request)`

Обрабатывает HTTP-запрос для добавления нового города в список пользователя.

**Параметры:**
- `request` (HttpRequest): Объект запроса, содержащий данные для добавления города.

**Возвращает:**
- `HttpResponse`: HTML-ответ, отрендеренный с шаблоном `add_city.html`, или перенаправление на главную страницу после успешного добавления города.

---

### `async def delete_city(request, city_id)`

Обрабатывает HTTP-запрос для удаления города из списка пользователя.

**Параметры:**
- `request` (HttpRequest): Объект запроса, содержащий информацию о текущем пользователе.
- `city_id` (int): Идентификатор города, который необходимо удалить.

**Возвращает:**
- `HttpResponse`: Перенаправление на главную страницу после удаления города.

---

### `async def city_weather(request)`

Обрабатывает HTTP-запрос для получения данных о погоде для выбранного города в заданном диапазоне дат.

**Параметры:**
- `request` (HttpRequest): Объект запроса, содержащий информацию о текущем пользователе и данные для получения погоды.

**Возвращает:**
- `HttpResponse`: HTML-ответ, отрендеренный с шаблоном `city_weather.html`, содержащий данные о погоде или форму для выбора параметров.

---

### `async def get_weather_data(latitude, longitude)`

Запрашивает данные о погоде для заданных координат.

**Параметры:**
- `latitude` (float): Широта местоположения.
- `longitude` (float): Долгота местоположения.

**Возвращает:**
- `dict` или `None`: Словарь с последними данными о погоде (температура, скорость ветра, давление) для указанных координат; в случае ошибки — `None`.

---

### `async def get_weather_parameters(latitude, longitude, start_date, end_date, selected_parameters)`

Запрашивает данные о погоде для заданных координат и диапазона дат.

**Параметры:**
- `latitude` (float): Широта местоположения.
- `longitude` (float): Долгота местоположения.
- `start_date` (str): Дата начала диапазона в формате 'YYYY-MM-DD'.
- `end_date` (str): Дата окончания диапазона в формате 'YYYY-MM-DD'.
- `selected_parameters` (list): Список параметров погоды, которые необходимо получить.

**Возвращает:**
- `DataFrame`: Pandas DataFrame с данными о погоде для указанных координат и диапазона дат.

---

### `class RegistrationForm(forms.ModelForm)`

Форма для регистрации нового пользователя.

**Поля:**
- `username` (str): Имя пользователя.
- `email` (str): Адрес электронной почты.
- `password` (str): Пароль пользователя (вводится скрытым текстом).

**Методы:**

- `clean_email()`: Проверяет, что email указан и не занят другим пользователем. Если email не указан или уже существует, выбрасывает `ValidationError`.

- `clean_username()`: Проверяет, что имя пользователя указано и не занято другим пользователем. Если имя пользователя не указано или уже существует, выбрасывает `ValidationError`.

- `clean_password()`: Проверяет, что пароль указан. Если пароль не указан, выбрасывает `ValidationError`.

---

### `class LoginForm(forms.Form)`

Форма для входа пользователя в систему.

**Поля:**
- `username` (str): Имя пользователя.
- `password` (str): Пароль пользователя.

---

### `class AddCityForm(forms.ModelForm)`

Форма для добавления нового города.

**Поля:**
- `name` (str): Название города.
- `latitude` (float): Широта города.
- `longitude` (float): Долгота города.

**Методы:**

- `clean()`: Переопределенный метод для валидации данных формы. Проверяет, что:
  - Название города указано.
  - Широта и долгота обязательны.
  - Широта и долгота являются числами.
  - Широта находится в диапазоне от -90 до 90.
  - Долгота находится в диапазоне от -180 до 180.

---

### `class DateRangeForm(forms.Form)`

Форма для выбора диапазона дат и параметров погоды для выбранного города.

**Поля:**
- `start_date` (DateField): Дата начала диапазона (вводится в формате даты).
- `end_date` (DateField): Дата окончания диапазона (вводится в формате даты).
- `cities` (ModelChoiceField): Выбор города из списка городов пользователя (необязательное поле).
- `parameters` (MultipleChoiceField): Множественный выбор параметров погоды с использованием чекбоксов.

**Методы:**

- `__init__(self, *args, **kwargs)`: Конструктор, который принимает пользователя и устанавливает queryset для поля `cities` на основе городов, связанных с пользователем.

- `clean()`: Переопределенный метод для валидации данных формы. Проверяет, что:
  - Даты начала и окончания указаны.
  - Дата окончания позже даты начала.

---

### `async def periodic_update()`

Запускает периодическое обновление кеша данных о погоде.

**Описание работы:**
Функция запускает бесконечный цикл, в котором каждые 15 минут вызывает функцию `update_cache_async()`.

---

### `async def update_cache_async()`

Обновляет кеш данных о погоде для всех городов.

**Описание работы:**
Функция логирует начало процесса обновления кеша, получает список всех городов из базы данных, а затем для каждого города запрашивает данные о погоде с использованием API.